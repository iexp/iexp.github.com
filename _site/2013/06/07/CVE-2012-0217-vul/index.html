<!doctype html>
<!--[if lt IE 7]> <html class="no-js ie6 oldie" lang="en"> <![endif]-->
<!--[if IE 7]>    <html class="no-js ie7 oldie" lang="en"> <![endif]-->
<!--[if IE 8]>    <html class="no-js ie8 oldie" lang="en"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"> <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

  <title>CVE-2012-0217漏洞分析 - Kernel Hack</title> 
  <meta name="description" content="Kernel Hack - OS Kernel Exploit">
  <meta name="author" content="iexp">
  <meta name="viewport" content="width=device-width,initial-scale=1">

  <link href='http://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600' rel='stylesheet' type='text/css'>
  <link href='http://fonts.googleapis.com/css?family=Source+Code+Pro:300,400' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/css/syntax.css">
  <link rel="stylesheet" href="/css/disqus.css">

  <script src="/js/libs/modernizr-2.0.6.min.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
</head>

<body>
  <div id="container">	  

    <header>
  <h1><a class="fadedlink" href="/" title="首页">&laquo;</a> CVE-2012-0217漏洞分析 <small>2013-06-07</small></h1>

  <nav>
    <ul class="clearfix">
    
      <li><a href="/tags/CVE-2012-0217.html">CVE-2012-0217</a></li>
    
    </ul>
  </nav>
</header>

<script>
// https://github.com/ghiculescu/jekyll-table-of-contents
$(document).ready(function() {
  var no_back_to_top_links = false

  var headers = $('h1, h2, h3, h4, h5, h6').filter(function() {return this.id}), // get all headers with an ID
      output = $('.toc');
  if (!headers.length || headers.length < 3 || !output.length)
    return;

  var get_level = function(ele) { return parseInt(ele.nodeName.replace("H", ""), 10) }
  var highest_level = headers.map(function(_, ele) { return get_level(ele) }).get().sort()[0]
  // var return_to_top = '<i class="icon-arrow-up back-to-top"> ^ </i>'
  var return_to_top = ''

  var level = get_level(headers[0]), this_level, html = "<i></i> <ol>";
  headers.on('click', function() {
    if (!no_back_to_top_links) window.location.hash = this.id
  }).addClass('clickable-header').each(function(_, header) {
    this_level = get_level(header);
    if (!no_back_to_top_links && this_level === highest_level) {
      $(header).addClass('top-level-header').after(return_to_top)
    }
    if (this_level === level) // same level as before; same indenting
      html += "<li><a href='#" + header.id + "'>" + header.innerHTML + "</a>";
    else if (this_level < level) // higher level than before; end parent ol
      html += "</li></ol></li><li><a href='#" + header.id + "'>" + header.innerHTML + "</a>";
    else if (this_level > level) // lower level than before; expand the previous to contain a ol
      html += "<ol><li><a href='#" + header.id + "'>" + header.innerHTML + "</a>";
    level = this_level; // update for the next one
  });
  html += "</ol>";
  if (!no_back_to_top_links) {
    $(document).on('click', '.back-to-top', function() {
      $(window).scrollTop(0)
      window.location.hash = ''
    })
  }
  output.hide().html(html).show('slow');
});
</script>
<div class="toc"></div>


<hr/>

<div id="post" role="main">
  <p>Intel sysret 在64位windows下引发的漏洞</p>

<h1 id="">漏洞描述:</h1>

<p>根据Intel手册描述，其 64位 CPU 下的sysret指令不主动进行栈切换，需要由开发人员自己显示切换GS, RBP和 RSP，当以上受影响操作系统由kernel-mode返回user-mode时，首先将GS,RBP和RSP恢复为user-mode的值，然后调用sysret。但是当返回地址为无效地址（有效地址的48-63位必须和第47位一致)时,sysret将会触发#GP异常，此时会跳到KiGeneralProtectionFault执行，由于 此时cpu运行在ring0,但RSP、RBP、GS已经切到user-mode地址空间，若精心构造gs所指向的值，可导致ring0下执行任意代码。</p>

<h1 id="_2">漏洞分析:</h1>

<p>查看 wrk1.2, base\ntos\ke\amd64\trap.asm 如下代码：</p>

<pre><code>       TRAP_ENTRY KiSystemCall64, KiSystemServiceHandler

        swapgs                          ; swap GS base to kernel PCR
        mov     gs:[PcUserRsp], rsp     ; save user stack pointer
        mov     rsp, gs:[PcRspBase]     ; set kernel stack pointer
        push    KGDT64_R3_DATA or RPL_MASK ; push dummy SS selector
        push    gs:[PcUserRsp]          ; push user stack pointer
        push    r11                     ; push previous EFLAGS
        push    KGDT64_R3_CODE or RPL_MASK ; push dummy 64-bit CS selector
        push    rcx                     ; push return address
        mov     rcx, r10                ; set first argument value</code></pre>

<p>以上代码为user-mode进入kernel-mode时的栈切换情况。</p>

<p>查看 RESTORE_TRAP_STATE 宏， 返回 ring3时的代码如下：</p>

<pre><code>        mov     r8, TrRsp[rbp]          ; get previous RSP value  ， 获取用户模式rsp
        mov     r9, TrRbp[rbp]          ; get previous RBP value
        xor     edx, edx                ; scrub volatile integer registers
        xor     r10, r10                      ;
        pxor    xmm0, xmm0              ; scrub volatile floating registers
        pxor    xmm1, xmm1              ;
        pxor    xmm2, xmm2              ;
        pxor    xmm3, xmm3              ;
        pxor    xmm4, xmm4              ;
        pxor    xmm5, xmm5              ;
        mov     rcx, TrRip[rbp]         ; get return address
        mov     r11, TrEFlags[rbp]      ; get previous EFLAGS
        mov     rbp, r9                 ; restore RBP
        mov     rsp, r8                 ; restore RSP     , 恢复用户模式rsp
        swapgs                          ; swap GS base to user mode TEB
        sysretq                         ; return from system call to user mode  ,如果此时发生异常， 堆栈已切到用户模式空间，但CPU运行在ring0.</code></pre>

<h1 id="_3">漏洞利用：</h1>

<p>利用User-Mode Scheduling (UMS)修改线程上下文环境。首先CreateUmsCompletionList()创建ums完成列表,然后调用EnterUmsSchedulingMode() （在此函数中会调用RtlpUmsPrimaryContextWrap ，其会将ring3的返回地址保存在 GS:[0x14a0]+0x10+0xF8 中)将自身线程由普通线程转换成UMS线程，我们可以在此时将GS:[0x14a0]+0x10+0xF8 中的值修改为一个无效地址，然后调用 ExecuteUmsThread来执行ums线程，最后,内核在完成一些操作后 会调用 KiUmsFastReturnToUser返回用户层，此函数中将rcx、rbp、rsp恢复为use-mode的值然后调用 sysret。由于sysret的返回地址无效，导致#GP异常, 执行流程：–&gt;KiGeneralProtectionFault –&gt; KiBugCheckDispatch –&gt; KeBugCheckEx –&gt; KiSaveProcessorControlState 在其调用过程中没有发现可利用的 代码执行指令，通过分析，发现可以通过构造 GS:0x20为一个非法值，可以在KiSaveProcessorControlState 函数中触发一个page fault异常，执行流程：KiPageFault –&gt; KiCheckForKernelApcDelivery –&gt; KiDeliverApc (在此函数中发现可利用的代码执行指令call r11)。</p>

<p><a href="http://www.vupen.com/blog/20120806.Advanced_Exploitation_of_Windows_Kernel_x64_Sysret_EoP_MS12-042_CVE-2012-0217.php">参考</a></p>
  <p class="back">&laquo; <a href="/">首页</a></p>
</div>

<!--
<h2>相关</h2>
<ul class="posts_list">
  
  <li class="post">
    <span class="date">2013-05-04</span> &raquo; <a href="/2013/05/04/CVE-2011-2018-vul" title="CVE-2011-2018 漏洞分析">CVE-2011-2018 漏洞分析</a>
  </li>
  
  <li class="post">
    <span class="date">2013-01-07</span> &raquo; <a href="/2013/01/07/irql" title="关于IRQL问题的记录">关于IRQL问题的记录</a>
  </li>
  
  <li class="post">
    <span class="date">2012-05-07</span> &raquo; <a href="/2012/05/07/Vmware-x64-guest-os-Eop" title="CVE-2008-4279 漏洞分析">CVE-2008-4279 漏洞分析</a>
  </li>
  
</ul>
-->

<hr/>

<h2>留言</h2>
<div id="disqus_thread"></div> <!-- css 样式 -->
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'iexp'; // required: replace example with your forum shortname
    //var disqus_developer = 1; // developer mode is on, for testing locally

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>


    <footer>
      <span>iexp </span>
      <a href="/categories/tags.html">tags</a>
    </footer>
  </div>

  <!--[if lt IE 7 ]>
    <script src="//ajax.googleapis.com/ajax/libs/chrome-frame/1.0.3/CFInstall.min.js"></script>
    <script>window.attachEvent('onload',function(){CFInstall.check({mode:'overlay'})})</script>
  <![endif]-->
</body>
</html>
